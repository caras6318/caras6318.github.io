---
title: Spring MVC(2)
date: 2024-04-10 21:04 +0900
categories: Spring
tags:
  - JAVA
  - Spring
---
## Intro
---
Spring MVC 강의를 듣고 정리한 내용입니다.
>아래 내용은 공부한 내용을 정리한 것으로 틀린 내용이 포함되어 있을 수 있습니다.  

## Servlet
---
서블릿은 다음과 같이 비즈니스 로직을 제외한 HTTP에 대한 요청정보를 대신 작성 해준다.

![[ServletRole.png]]

서블릿은 다음과 같은 형태를 가진다.

![[ServletCode.png]]

urlPatterns(/hello)의 URL이 호출되면 서블릿 코드가 실행 되며

>HttpServletRequest : HTTP 요청 정보를 편리하게 사용할 수 있다.
HttpServletResponse HTTP 응답 정보를 편리하게 제공할 수 있다.

개발자는 HTTP 스펙을 매우 편리하게 사용가능해진다.
HTTP 요청이 들어오면 WAS는 Request, Response 객체를 새로 만들어서 서블릿 객체 호출하고 개발자는 Request 객체에서 HTTP 요청 정보를 편리하게 꺼내서 사용하며 또한, 개발자는 Response 객체에 HTTP 응답 정보를 편리하게 입력할 수 있다. 그러면 WAS는 Response 객체에 담겨있는 내용으로 HTTP 응답 정보를 생성한다. 이러한 흐름을 정리하면 아래와 같다.

![[ServletFlow.png]]

### 서블릿 컨테이너
---
톰캣처럼 서블릿을 지원하는 WAS를 서블릿 컨테이너라고 하는데 서블릿 컨테이너는 서블릿 객체를 생성, 초기화, 호출, 종료하는 생명주기 관리 한다. 

서블릿 객체는 싱글톤으로 관리하고 (처음에 서블릿 객체를 미리 만들어두고 재활용) == 공유 변수 사용 주의 
서블릿 컨테이너 종료시 함께 종료되며 동시 요청을 위한 멀티 쓰레드 처리 지원한다.
![[ServletContainer.png]]
### 멀티 쓰레드
---
멀티쓰레드란 동시요청 쓰레드를 의미한다.

>어플리케이션 코드를 하나씩 순차적으로 실행하는 것이 쓰레드이다.
JAVA에서 메인 메서드를 처음 실행하면 main이라는 이름의 쓰레드가 실행된다.
쓰레드가 없다면 자바 어플리케이션 실행이 불가능하다.
한번에 하나의 코드라인만 수행하기 때문에 동시 처리가 필요하면 쓰레드를 추가로 생성한다.

![[SingleThread.png]]

![[MultiThread.png]]

장점 
	동시 요청을 처리할 수 있다. 
	리소스(CPU, 메모리)가 허용할 때 까지 처리가능 
	하나의 쓰레드가 지연 되어도, 나머지 쓰레드는 정상 동작한다. 

단점
	쓰레드는 생성 비용은 매우 비싸다.
	고객의 요청이 올 때 마다 쓰레드를 생성하면, 응답 속도가 늦어진다. 
	쓰레드는 컨텍스트 스위칭 비용이 발생한다. 
	쓰레드 생성에 제한이 없다 -> 요청이 너무 많이 오면, CPU, 메모리 임계점을 넘어서 서버가 죽을 수 있다.

이러한 문제점을 해결하기 위해서 대부분의 WAS는 내부에 쓰레드 풀을 구현해놓는다.

![[ThreadPool.png]]

쓰레드 풀 내부에 미리 쓰레드를 만들어놓고 요청만큼 쓰레드 풀에서 꺼내어 쓰다가 요청이 완료되면 반납한다.

특징
	필요한 쓰레드를 쓰레드 풀에 보관하고 관리한다. 
	쓰레드 풀에 생성 가능한 쓰레드의 최대치를 관리한다. 톰캣은 최대 200개 기본 설정 (변경 가능)
사용
	쓰레드가 필요하면, 이미 생성되어 있는 쓰레드를 쓰레드 풀에서 꺼내서 사용한다.
	사용을 종료하면 쓰레드 풀에 해당 쓰레드를 반납한다.
	최대 쓰레드가 모두 사용중이어서 쓰레드 풀에 쓰레드가 없으면?
	-> 기다리는 요청은 거절하거나 특정 숫자만큼만 대기하도록 설정할 수 있다.
장점
	쓰레드가 미리 생성되어 있으므로, 쓰레드를 생성하고 종료하는 비용(CPU)이 절약되고, 응답 시간이 빠르다.
	생성 가능한 쓰레드의 최대치가 있으므로 너무 많은 요청이 들어와도 기존 요청은 안전하게 처리할 수 있다.

### 정리
---
중요한것은 멀티 쓰레드에 대한 부분은 WAS가 처리하기 때문에 개발자가 멀티 쓰레드 관련 코드를 신경쓰지 않아도 된다는 점이다. 개발자는 싱글 쓰레드 프로그래밍을 하듯 편하게 개발할 수 있다. 
멀티 쓰레드 환경이므로 싱글톤 객체(서블릿, 스프링 빈)는 주의해서 사용해야한다.
#### Tip
---
WAS의 주요 튜닝 포인트는 최대 쓰레드(max thread) 수이다.
이 값을 너무 낮게 설정하면? 
	동시 요청이 많으면, 서버 리소스는 여유롭지만, 클라이언트는 금방 응답 지연 

이 값을 너무 높게 설정하면? 
	동시 요청이 많으면, CPU, 메모리 리소스 임계점 초과로 서버 다운

 장애 발생시? 
	  클라우드면 일단 서버부터 늘리고, 이후에 튜닝
	  클라우드가 아니면 열심히 튜닝

적정값을 찾기 위해서 성능테스트를 진행한다.
### Reference
---
[스프링 MVC](https://www.inflearn.com/course/%EC%8A%A4%ED%94%84%EB%A7%81-mvc-1)
